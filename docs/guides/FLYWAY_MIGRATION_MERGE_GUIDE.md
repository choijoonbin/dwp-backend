# Flyway 마이그레이션 파일 Merge 가이드

## 질문: 마이그레이션 파일들을 하나로 합칠 수 있나요?

**답변**: 상황에 따라 다릅니다.

---

## Flyway 마이그레이션 파일의 특성

### 1. 버전 기반 순차 실행
- Flyway는 파일명의 버전 번호(`V1`, `V2`, ...)를 기준으로 순차적으로 실행합니다
- 각 마이그레이션은 `flyway_schema_history` 테이블에 기록됩니다
- 실행된 마이그레이션은 checksum으로 검증됩니다

### 2. 이미 실행된 마이그레이션은 수정 불가
- **절대 수정하면 안 됨**: 이미 실행된 마이그레이션 파일을 수정하면 checksum 불일치 오류 발생
- **절대 삭제하면 안 됨**: 삭제하면 Flyway가 마이그레이션 상태를 추적할 수 없음

---

## Merge 가능한 경우

### ✅ Case 1: 개발 초기 단계 (아직 배포 전)
**조건**:
- 데이터베이스가 비어있거나 개발 환경만 존재
- `flyway_schema_history` 테이블이 없거나 비어있음
- 프로덕션 환경에 배포되지 않음

**방법**:
1. 모든 마이그레이션 파일의 내용을 하나의 파일로 합치기
2. 기존 V1~V20 파일 삭제
3. 새로운 V1 파일 생성 (모든 스키마 포함)
4. 데이터베이스 초기화 후 재실행

**장점**:
- 파일 관리가 단순해짐
- 마이그레이션 히스토리가 깔끔해짐

**단점**:
- 마이그레이션 히스토리 추적이 어려워짐
- 각 변경사항의 시점을 알기 어려움

---

## Merge 불가능한 경우

### ❌ Case 2: 이미 프로덕션에 배포됨
**조건**:
- 프로덕션 데이터베이스에 마이그레이션이 실행됨
- `flyway_schema_history` 테이블에 기록이 있음
- 다른 개발자/환경에서 이미 사용 중

**결과**:
- 기존 마이그레이션 파일 수정/삭제 시 checksum 불일치 오류 발생
- 다른 환경과 동기화 불가능
- 데이터베이스 상태 불일치 발생

**해결책**:
- **기존 파일은 그대로 유지**
- 새로운 변경사항은 새로운 버전(V21, V22, ...)으로 추가

---

## 현재 상황 확인 방법

### 1. 데이터베이스 마이그레이션 상태 확인

```sql
-- flyway_schema_history 테이블 확인
SELECT version, description, installed_on, success 
FROM flyway_schema_history 
ORDER BY installed_rank;
```

**결과 해석**:
- **비어있음**: Merge 가능 (개발 초기 단계)
- **기록 있음**: Merge 불가능 (이미 실행됨)

### 2. 프로덕션 환경 확인

```bash
# 프로덕션 데이터베이스에 접속하여 확인
psql -h <prod-host> -U <user> -d dwp_auth -c "SELECT COUNT(*) FROM flyway_schema_history;"
```

---

## 권장 사항

### 개발 초기 단계라면: Merge 가능 ✅

**절차**:
1. 모든 마이그레이션 파일 내용 확인
2. 하나의 V1 파일로 통합 (순서 유지)
3. 기존 V1~V20 파일 백업 후 삭제
4. 데이터베이스 초기화
5. 새로운 V1 파일로 재실행

**주의사항**:
- 모든 팀원과 협의 필요
- 데이터베이스 백업 필수
- 모든 환경(dev, staging, prod)에서 동시에 적용

### 이미 배포되었다면: Merge 불가능 ❌

**권장 사항**:
- 기존 파일은 그대로 유지
- 새로운 변경사항은 새로운 버전으로 추가
- 마이그레이션 히스토리는 유지하는 것이 좋음

**이유**:
- 각 마이그레이션은 "언제 무엇이 변경되었는지"를 기록
- 롤백 시 특정 버전으로 되돌릴 수 있음
- 문제 발생 시 원인 추적 가능

---

## 현재 마이그레이션 파일 분석

현재 20개의 마이그레이션 파일이 있습니다:

1. **V1**: IAM 스키마 생성 (기본 테이블 17개)
2. **V2**: Seed 데이터 삽입
3. **V3**: 모니터링 컬럼 추가
4. **V4**: latency_ms 타입 수정
5. **V5**: Admin 메뉴 리소스 추가
6. **V6**: sys_menus 테이블 생성
7. **V7**: sys_menus Seed 데이터
8. **V8**: sys_menus 컬럼 타입 수정
9. **V9**: 코드 테이블 생성
10. **V10**: 코드 Seed 데이터
11. **V11**: event_logs 테이블 생성
12. **V12**: sys_code_usages 테이블 생성
13. **V13**: sys_code_usages Seed 데이터
14. **V14**: auth_policies 및 idp 확장
15. **V15**: auth_policy 및 idp Seed 데이터
16. **V16**: com_resources tracking 확장
17. **V17**: sys_codes에 tenant_id 추가
18. **V18**: 리소스 tracking 코드 Seed
19. **V19**: event_logs에 resource_kind 추가
20. **V20**: bytea 컬럼 수정

**특징**:
- 각 마이그레이션은 특정 기능/버그 수정을 담당
- 순차적으로 의존성이 있음 (V6 → V7 → V8)
- 일부는 버그 수정 (V4, V8, V20)

---

## 결론 및 권장사항

### 현재 상황 확인 필요

1. **개발 환경만 존재하는가?**
   - → Merge 가능 (V1 하나로 통합)

2. **프로덕션에 이미 배포되었는가?**
   - → Merge 불가능 (기존 파일 유지)

### 권장 사항

**일반적으로는 Merge하지 않는 것을 권장합니다:**

1. **마이그레이션 히스토리 유지**: 각 변경사항의 시점과 이유를 추적 가능
2. **롤백 가능**: 특정 버전으로 되돌릴 수 있음
3. **문제 추적**: 특정 마이그레이션에서 문제 발생 시 쉽게 찾을 수 있음
4. **표준 관행**: Flyway의 일반적인 사용 방법

**Merge를 고려할 수 있는 경우:**

- 개발 초기 단계 (아직 배포 전)
- 모든 팀원이 동의한 경우
- 데이터베이스 초기화가 가능한 경우

---

## 참고 문서

- [Flyway 공식 문서](https://flywaydb.org/documentation/)
- [Flyway 체크섬 수정 가이드](./FLYWAY_REPAIR_GUIDE.md)
- [Flyway 트러블슈팅](../troubleshooting/FLYWAY_CHECKSUM_FIX.md)
