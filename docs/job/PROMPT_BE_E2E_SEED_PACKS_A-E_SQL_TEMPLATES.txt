[BACKEND PROMPT] E2E용 Seed 데이터 생성(표준) — Pack A~E SQL 템플릿 생성 + 적재 스크립트까지 완성
(대상: DWP Backend / DB(PostgreSQL). 목표: “배치→케이스→SSE→HITL→Audit” E2E를 빠르게/반복 재현 가능하게 만드는 최소 데이터셋을 SQL로 제공)

## 0) 전제(이미 구현된 운영 기능)
- Detect Batch + Admin API + Scheduler Status + SKIPPED 보강 + RBAC(Feign auth-server check)까지 반영된 상태임. fileciteturn13file0
- 프론트는 Scheduler Status 카드/403 UX/SKIPPED 토스트까지 반영된 상태임. fileciteturn13file1

---

## 1) 목적(정확히 이 산출물을 만든다)
1) **Pack A~E**를 만들기 위한 “정확한 컬럼 세팅”을 확정(스키마 기준)
2) **실행 가능한 SQL 템플릿(INSERT/UPSERT)** 을 생성
3) **적재/정리/검증 스크립트**(truncate/tenant purge/시간 조정/윈도우 설정)까지 포함
4) 결과적으로 사용자는 기존 데이터 삭제 후, SQL 한 번 실행으로 E2E 재현 가능

> 산출물 파일(필수): `docs/e2e/seed/PACK_A-E_seed.sql`  
> 보조 파일(필수): `docs/e2e/seed/README.md` (실행 순서/파라미터/검증 쿼리)

---

## 2) 절대 원칙(가정 금지)
- 테이블명/컬럼명/제약/시퀀스는 **현재 DDL 및 엔티티/리포지토리 코드에서 확인한 것만** 사용.
- detect 배치가 실제로 참조하는 “입력 테이블”(전표/오픈아이템/원천 이벤트)을 코드에서 찾아 그 테이블에만 데이터를 넣는다.
- 테넌트 스코프 강제: 모든 seed는 하나의 E2E 테넌트(`TENANT_E2E_01`)로만 적재.
- 시간 스코프: 배치가 잡는 윈도우에 들어오도록 created_at/updated_at/posted_at(실제 컬럼) 값을 **고정된 범위로 설정**.

---

## 3) 먼저 해야 할 “스키마/참조” 확인 체크리스트(필수)
아래를 코드/DDL에서 찾아 README에 명시하라.

### 3.1 detect 입력 테이블
- DetectBatchService가 조회하는 테이블/쿼리
  - 예: `fi_doc_header`(전표 헤더), `fi_doc_item`(라인), `fi_open_item`, 또는 `sap_raw_events` 등
- 배치가 사용하는 시간 컬럼
  - 예: created_at / updated_at / doc_date / posting_date 등

### 3.2 Case/Evidence/HITL/Audit 관련 테이블
- case 테이블(예: agent_case) PK/필수 컬럼
- evidence 테이블이 있으면(없으면 case에 refs로만) 연결 키
- action proposal/approval 테이블(있으면) 또는 audit_event_log 기반 처리 방식
- audit_event_log의 필수 컬럼(tenant_id, user_id, case_id, event_type, payload_json 등)

### 3.3 필수 FK/NOT NULL/enum 값
- status/severity enum(실제 허용 값)
- bukrs/belnr/gjahr/… 같은 도메인 키(실제 타입/길이)

---

## 4) Pack 정의(업계 표준 E2E 최소 팩)
각 Pack은 “케이스가 반드시 생성/업데이트되도록” 입력 데이터를 설계해야 한다.
(※ 룰/임계치/매핑은 현재 구현 기준으로 조정)

### Pack A: 정상(HIGH) + Evidence 3종 + HITL propose 발생
- 목적: 가장 대표 E2E(배치→케이스→SSE→승인→감사)
- 데이터:
  - 전표 20~30건 (동일 벤더/계정/금액 패턴 등, 룰이 잡히도록)
  - 오픈아이템 10~20건 (전표와 연결 키 일치)
  - lineage가 있다면 최소 1건 (belnr/gjahr 등 연결)
- 기대:
  - detect_run 1회 실행 후 케이스 1~3개 생성
  - Aura 분석 시 hitl_proposed 이벤트 발생(또는 최소 propose_action 생성)

### Pack B: 정상(MEDIUM) + propose가 없거나 reject 유도
- 목적: “처리 불필요/리스크 낮음” 흐름 및 reject 테스트
- 데이터:
  - 전표 10~20건, 임계치 근처(혹은 룰 하나만 만족)
- 기대:
  - 케이스 생성되거나, 생성되더라도 propose가 없을 수 있음
  - 수동/자동 propose가 있으면 reject로 마감

### Pack C: Upsert 검증(중복 방지)
- 목적: 동일 엔티티(=dedup_key)로 2회 적재 시 “케이스 1개 업데이트” 확인
- 데이터:
  - Pack A에서 사용한 동일 entity_key로 전표를 “시간만 다르게” 10~20건 추가
- 기대:
  - 케이스 신규 생성이 아니라 updated_count 증가
  - agent_case.dedup_key 기준으로 케이스가 1개 유지됨

### Pack D: 락/SKIPPED(동시 실행)
- 목적: advisory lock이 실제로 동작해 SKIPPED 응답/운영 UX 검증
- 데이터:
  - 데이터는 Pack A/B 어느 것이든 재사용 가능(중요한 건 동시 실행)
- 기대:
  - 수동 실행을 거의 동시에 2회 호출 시 두 번째는 SKIPPED + runningRunId/skipReason 포함

### Pack E: 권한(403) 시나리오
- 목적: AdminGuardFilter 권한 차단/프론트 403 UX 검증
- 데이터:
  - 별도 데이터 필요 없음
- 기대:
  - 권한 없는 토큰으로 `/api/synapse/admin/detect/*` 접근 시 403
  - FE에서 “권한 없음” 메시지 + retry 없음

---

## 5) SQL 템플릿 작성 규칙(중요)
### 5.1 파라미터화(README에 명시)
- :tenant_id  (기본 TENANT_E2E_01)
- :user_id    (기본 E2E_DEMO_USER)
- :base_time  (예: 2026-02-05 00:00:00+09) — 윈도우 정렬 기준
- :window_from / :window_to (backfill 실행용)

### 5.2 시간 컬럼 세팅
- 배치가 사용하는 컬럼(created_at/updated_at/posted_at)을 :base_time 기준으로 “윈도우 안”에 들어오도록 설정
- Pack C는 같은 entity_key로 updated_at만 뒤로 이동해 upsert 업데이트를 유도

### 5.3 키/참조 무결성
- 전표 헤더/라인/오픈아이템 간 연결 키를 실제 스키마로 맞춘다
- 예:
  - (bukrs, belnr, gjahr) 또는 (doc_id)로 조인되면 그 조합을 동일하게 생성

### 5.4 볼륨(필수: 작게)
- Pack A/B/C 합쳐서 “전표 60~120건” 수준을 넘기지 말 것(배치 빠르게)
- 대량 더미는 별도 성능 테스트로 분리

---

## 6) 파일 구성(반드시 이렇게)
### 6.1 `docs/e2e/seed/PACK_A-E_seed.sql`
구성 순서:
1) (선택) 기존 E2E 테넌트 데이터 정리(DELETE WHERE tenant_id=:tenant_id)
2) Pack A INSERT
3) Pack B INSERT
4) Pack C INSERT(업서트 유도용 — 시간/금액 조정 포함)
5) (선택) ingest_run 생성/연결(존재한다면)
6) 검증 쿼리(SELECT count, sample rows)

### 6.2 `docs/e2e/seed/README.md`
- 실행 순서:
  1) 기존 데이터 백업/삭제 안내(사용자가 수행)
  2) SQL 실행(파라미터 예시 제공)
  3) detect_run 실행 방법(윈도우/백필)
  4) FE로 확인(케이스 목록→상세→SSE→HITL→Audit)
- 검증 SQL:
  - detect_run 최근 5개
  - agent_case 최근 20개
  - audit_event_log caseId 기준 조회 예시

---

## 7) E2E 실행 가이드(README에 포함)
### 7.1 배치 실행(권장)
- Admin 메뉴 Run Now 또는
- curl: `/api/synapse/admin/detect/run` with `{ "windowMinutes": 1440 }` (데이터 범위에 맞게)

### 7.2 케이스 확인
- FE Command Center/Cases에서 최신 케이스 확인
- 케이스 상세에서 evidence 링크 3종이 “실제 데이터”로 열리는지 확인

### 7.3 Aura 포함 여부
- Aura 서버가 있다면: SSE 단계형 이벤트와 hitl_proposed 확인
- Aura 없이도: 케이스/감사/배치 관제까지는 검증 가능(단, ‘Agentic 장면’은 제외)

---

## 8) 완료조건(Definition of Done)
- `PACK_A-E_seed.sql`이 **스키마 검증을 통과**하고 실제 INSERT가 성공
- detect_run 1회 실행 후:
  - Pack A 케이스 1~3개 생성
  - Pack C는 신규 케이스 증가 없이 updated_count만 증가
- Pack D: 동시 수동 실행 시 SKIPPED 응답 확인
- Pack E: 권한 없는 토큰 403 확인
- 모든 과정에서 tenant 혼입이 0

---

## 9) 제출물(필수)
- `docs/e2e/seed/PACK_A-E_seed.sql`
- `docs/e2e/seed/README.md`
- (선택) `docs/e2e/seed/VERIFY_QUERIES.sql` (검증 쿼리만 분리)

> 이 프롬프트의 핵심은 “가정 없이 실제 스키마/배치 입력 테이블 기준으로 재현 가능한 최소 데이터팩을 만든다” 입니다.
