server:
  port: 8080

spring:
  application:
    name: dwp-gateway
  main:
    web-application-type: reactive  # Gateway는 WebFlux 기반이므로 reactive로 설정
  cloud:
    gateway:
      # SSE(Server-Sent Events) 지원을 위한 타임아웃 설정
      httpclient:
        response-timeout: 300s  # AI 스트리밍 응답을 위해 5분으로 설정
        connect-timeout: 10000  # 10초
        # SSE 스트리밍 최적화: 커넥션 유지 및 버퍼링 비활성화
        pool:
          max-connections: 500
          max-idle-time: 30s
      routes:
        # HITL API 라우팅 (Main Service)
        - id: hitl-api
          uri: ${SERVICE_MAIN_URL:http://localhost:8081}
          predicates:
            - Path=/api/aura/hitl/**
          filters:
            - StripPrefix=1
        # Monitoring 수집 API 라우팅 (Auth Server)
        - id: monitoring-collect
          uri: ${SERVICE_AUTH_URL:http://localhost:8001}
          predicates:
            - Path=/api/monitoring/**
          filters:
            - StripPrefix=1
        # SynapseX Service (Admin/통화·PII 정책, Audit 감사로그) - 프론트 제공 API: /api/synapse/**
        - id: synapsex-admin
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/admin/**
          filters:
            - StripPrefix=1
        - id: synapsex-audit
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/audit/**
          filters:
            - StripPrefix=1
        - id: synapsex-entities
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/entities/**
          filters:
            - StripPrefix=1
        - id: synapsex-integration
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/integration/**
          filters:
            - StripPrefix=1
        - id: synapsex-documents
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/documents/**
          filters:
            - StripPrefix=1
        - id: synapsex-open-items
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/open-items/**
          filters:
            - StripPrefix=1
        - id: synapsex-lineage
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/lineage/**
          filters:
            - StripPrefix=1
        - id: synapsex-cases
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/cases/**
          filters:
            - StripPrefix=1
        - id: synapsex-dashboard
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/dashboard/**
          filters:
            - StripPrefix=1
        - id: synapsex-anomalies
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/anomalies/**
          filters:
            - StripPrefix=1
        - id: synapsex-actions
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/actions/**
          filters:
            - StripPrefix=1
        - id: synapsex-archive
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/archive/**
          filters:
            - StripPrefix=1
        # Phase 3: RAG, Policies, Guardrails, Dictionary, Feedback
        - id: synapsex-rag
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/rag/**
          filters:
            - StripPrefix=1
        - id: synapsex-policies
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/policies/**
          filters:
            - StripPrefix=1
        - id: synapsex-guardrails
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/guardrails/**
          filters:
            - StripPrefix=1
        - id: synapsex-dictionary
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/dictionary/**
          filters:
            - StripPrefix=1
        - id: synapsex-feedback
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/feedback/**
          filters:
            - StripPrefix=1
        # Phase 4: Reconciliation, Action-recon, Analytics
        - id: synapsex-reconciliation
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/reconciliation/**
          filters:
            - StripPrefix=1
        - id: synapsex-action-recon
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/action-recon/**
          filters:
            - StripPrefix=1
        - id: synapsex-analytics
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/analytics/**
          filters:
            - StripPrefix=1
        - id: synapsex-optimization
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/optimization/**
          filters:
            - StripPrefix=1
        # Agent Tool API (Aura 호출용) - /api/synapse/agent-tools/**
        - id: synapsex-agent-tools
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          predicates:
            - Path=/api/synapse/agent-tools/**
          filters:
            - StripPrefix=1
        # Aura Dashboard → SynapseX 프록시 (Aura 전달사항: /api/aura/dashboard/* 별칭)
        # /api/synapse/dashboard/* 유지, /api/aura/dashboard/* 요청도 synapsex로 전달
        - id: aura-dashboard-synapsex
          uri: ${SERVICE_SYNAPSEX_URL:http://localhost:8085}
          order: -1
          predicates:
            - Path=/api/aura/dashboard/**
          filters:
            - RewritePath=/api/aura/dashboard(?<segment>.*), /synapse/dashboard$\{segment}
        # Aura Platform (AI Agent) 라우팅 - Python
        # ⚠️ 중요: 프론트엔드는 반드시 Gateway(8080)를 통해 Aura-Platform과 통신해야 합니다.
        # 직접 Aura-Platform(9000)에 접근하는 것은 금지됩니다.
        # 
        # AI 에이전트의 스트리밍 응답(SSE)을 중간에 끊기지 않도록 별도 타임아웃 적용
        # ✅ 포트 9000 확정: Aura-Platform은 포트 9000을 사용합니다
        - id: aura-platform
          uri: ${AURA_PLATFORM_URL:http://localhost:9000}  # env 변수명 표준화
          predicates:
            - Path=/api/aura/**
          filters:
            - StripPrefix=1  # /api/aura/** → /aura/**로 변환
            # 헤더 전파 보장 (Authorization, X-Tenant-ID, X-DWP-Source, X-DWP-Caller-Type 등)
            # - RequiredHeaderFilter: X-Tenant-ID 필수 검증 및 기본값 설정
            # - HeaderPropagationFilter: 모든 표준 헤더 다운스트림 전파
            - PreserveHostHeader
            # ✅ POST 요청 body 전달 보장:
            # - Spring Cloud Gateway는 기본적으로 POST 요청의 body를 자동으로 전달합니다
            # - RequestBodyLoggingFilter가 body 전달 여부를 로깅하여 확인합니다
            # - 프론트엔드의 POST /api/aura/test/stream 요청 body (prompt, context)가
            #   Aura-Platform까지 유실 없이 전달됩니다
            # SSE 스트리밍 최적화:
            # - response-timeout: 300s (위에서 설정)
            # - Gateway는 기본적으로 text/event-stream을 자동으로 스트리밍 처리
            # - 커넥션 유지 및 버퍼링 최적화는 httpclient.pool 설정으로 처리
            # - SseResponseHeaderFilter: SSE 응답 헤더 보장 (Content-Type, Cache-Control, Connection, X-Accel-Buffering)
            # - SseReconnectionFilter: Last-Event-ID 헤더 전파 및 Event ID 생성
            # TODO: 향후 Aura-Platform 요청에 대한 JWT 검증 확장 포인트
            # - 현재는 Authorization 헤더를 그대로 전파하지만, 필요 시 Gateway에서 JWT 검증 추가 가능
            # - Auth Server와 통신하여 JWT 검증 후 Aura-Platform으로 전달하는 구조 확장 가능
        # Main Service 라우팅
        # 프론트엔드: http://localhost:8080/api/main/health
        # → Gateway가 /api 제거 후 → http://localhost:8081/main/health로 전달
        - id: main-service
          uri: ${SERVICE_MAIN_URL:http://localhost:8081}
          predicates:
            - Path=/api/main/**
          filters:
            - StripPrefix=1
        - id: auth-server
          uri: ${SERVICE_AUTH_URL:http://localhost:8001}
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
        # Admin API 라우팅 (Auth Server)
        - id: admin-api
          uri: ${SERVICE_AUTH_URL:http://localhost:8001}
          predicates:
            - Path=/api/admin/**
          filters:
            - StripPrefix=1
        - id: mail-service
          uri: ${SERVICE_MAIL_URL:http://localhost:8082}
          predicates:
            - Path=/api/mail/**
          filters:
            - StripPrefix=1
        - id: chat-service
          uri: ${SERVICE_CHAT_URL:http://localhost:8083}
          predicates:
            - Path=/api/chat/**
          filters:
            - StripPrefix=1
        - id: approval-service
          uri: ${SERVICE_APPROVAL_URL:http://localhost:8084}
          predicates:
            - Path=/api/approval/**
          filters:
            - StripPrefix=1

# CORS 설정
# 환경 변수 CORS_ALLOWED_ORIGINS를 통해 허용할 Origin을 설정할 수 있습니다.
# 기본값: http://localhost:4200 (로컬 개발 환경)
# 여러 Origin을 허용하려면 콤마(,)로 구분하여 설정하세요.
# 예시: CORS_ALLOWED_ORIGINS=http://localhost:4200,https://example.com
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:4200}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,PATCH,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:*}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  max-age: ${CORS_MAX_AGE:3600}

logging:
  level:
    '[org.springframework.cloud.gateway]': DEBUG
    '[org.springframework.web]': DEBUG

