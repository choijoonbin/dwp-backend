ğŸ›¡ï¸ DWP Backend Integrated Development Rules (v1.6 - Final Merged)

0. ëª©ì  (Goal)
DWP BackendëŠ” DWP Frontend(Host/Remote) ë° Aura-Platform(Python/FastAPI)ê³¼ í†µí•©ë˜ëŠ” ë©€í‹° ëª¨ë“ˆ MSAì´ë‹¤.
ë³¸ RulesëŠ” â€œí”„ë¡ íŠ¸/ê²Œì´íŠ¸ì›¨ì´/ì„œë¹„ìŠ¤ ê°„ ê³„ì•½(Contract)â€ì„ ì½”ë“œë¡œ ê³ ì •í•˜ì—¬ ì‹œìŠ¤í…œ ì „ì²´ì˜ í†µí•© ì•ˆì •ì„±ê³¼ ì¶”ì  ê°€ëŠ¥ì„±(Traceability)ì„ ë³´ì¥í•œë‹¤.

1. ì•„í‚¤í…ì²˜ ì›ì¹™ & ëª¨ë“ˆë³„ ì—­í• 
- Multi-Module MSA: Spring Boot 3.4.x ê¸°ë°˜ Gradle ë©€í‹° ëª¨ë“ˆ êµ¬ì¡°ë¥¼ ì—„ê²©íˆ ì¤€ìˆ˜í•œë‹¤.
- Single Ownership Principle:
  - dwp-core: ê³µí†µ ê¸°ë°˜. DTO, ApiResponse<T>, ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬, HeaderConstants, Redis ê³µí†µ ì„¤ì •, ê³µí†µ ìœ í‹¸
  - dwp-gateway: ìœ ì¼í•œ ì™¸ë¶€ ì§„ì…ì . ë¼ìš°íŒ…, í—¤ë” ì „íŒŒ(Propagation), CORS, SSE ìŠ¤íŠ¸ë¦¬ë° ì¤‘ê³„, ê³µí†µ ë¡œê¹…(API Call History) ì „ë‹´
  - dwp-auth-server: ì¸ì¦/ì¸ê°€ + Admin ì˜ì—­(IAM/RBAC/Monitoring/Code/Policy) ë‹¨ì¼ ì†Œìœ 
  - dwp-main-service: ìƒíƒœ ê´€ë¦¬. AgentTask, HITL ì„¸ì…˜, ì¥ê¸° ì‹¤í–‰ ì‘ì—…(Lifecycle) ê´€ë¦¬ ë‹¨ì¼ ì†Œìœ 
  - services/*: ë„ë©”ì¸ ì„œë¹„ìŠ¤. AI ì—ì´ì „íŠ¸ê°€ í˜¸ì¶œí•˜ëŠ” ê°œë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë„êµ¬(Tool) API ì œê³µ

âœ… Admin ê¸°ëŠ¥ ê°œë°œ ì›ì¹™
- IAM/RBAC/Monitoring/Code/AuthPolicy/IDP ë“± â€œê³µí†µ ìš´ì˜ ê¸°ëŠ¥â€ì€ dwp-auth-serverì— ì§‘ì¤‘í•œë‹¤.
- ì„œë¹„ìŠ¤ ë„ë©”ì¸(ERP ë“±) ê¸°ëŠ¥ì€ services/* ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê¸°ë³¸ ì›ì¹™ìœ¼ë¡œ í•˜ë˜,
  í˜„ì¬ ë‹¨ê³„ì—ì„œëŠ” ì•ˆì •í™” í›„ ë¶„ë¦¬ë¥¼ í—ˆìš©í•œë‹¤.

2. í†µí•© ê³„ì•½ ë° í—¤ë” í‘œì¤€ (Header Contract)
ëª¨ë“  ìš”ì²­ì€ Gateway(8080)ë¥¼ ê±°ì¹˜ë©°, ë‹¤ìŒ í—¤ë”ëŠ” ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ë° FeignClient í†µì‹  ì‹œ ëˆ„ë½ ì—†ì´ ì „íŒŒë˜ì–´ì•¼ í•œë‹¤.

2.1 í•„ìˆ˜ ë³´ì•ˆ í—¤ë” (Required)
- Authorization: Bearer <JWT>
  - HS256 ê¸°ë°˜ ì„œëª… ê²€ì¦
  - tenant_id í´ë ˆì„ í•„ìˆ˜
  - í‘œì¤€ ì‹œê°„ í´ë ˆì„(iat/exp) ê¸°ë°˜ ë§Œë£Œ ì²˜ë¦¬ ê¶Œì¥
- X-Tenant-ID: ë©€í‹°í…Œë„Œì‹œ ì‹ë³„ì (DB ì¡°íšŒ ì‹œ tenant filter ê°•ì œ)
- X-User-ID: ì‚¬ìš©ì ì‹ë³„ì

2.2 ì¶”ì  ë° ì»¨í…ìŠ¤íŠ¸ í—¤ë” (Trace/Context)
- X-Agent-ID: Aura ì—ì´ì „íŠ¸ ì„¸ì…˜/í´ë¼ì´ì–¸íŠ¸ ì‹ë³„ì
- X-DWP-Source: ìš”ì²­ ì¶œì²˜ (FRONTEND, AURA, INTERNAL, BATCH)
- X-DWP-Caller-Type: í˜¸ì¶œì ìœ í˜• (USER, AGENT, SYSTEM)

3. ì—ì´ì „í‹± AI & SSE í†µì‹  ê·œê²© (Agentic AI & SSE)
3.1 SSE ê¸°ë³¸ ê·œì¹™
- Streaming: MediaType.TEXT_EVENT_STREAM_VALUE ì‚¬ìš©
- Gateway Timeout: SSE ìŠ¤íŠ¸ë¦¼ì´ ëŠê¸°ì§€ ì•Šë„ë¡ 300ì´ˆ ì´ìƒ ì„¤ì •
- Buffering ë°©ì§€: ì¤‘ê°„ í”„ë¡ì‹œ/ê²Œì´íŠ¸ì›¨ì´ì—ì„œ ë²„í¼ë§ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
- Method: POST ê¸°ë°˜ SSE ì‘ë‹µ ê³µì‹ ì§€ì›

3.2 SSE ì¬ì—°ê²° ë° ìƒíƒœ ë³µêµ¬ (Resilience)
- Event ID: ëª¨ë“  SSE ì´ë²¤íŠ¸ì— ë‹¨ì¡° ì¦ê°€ eventId/sequence í¬í•¨ ê¶Œì¥
- Last-Event-ID: ì¬ì—°ê²° ì‹œ resume ê°€ëŠ¥í•˜ë©´ ì§€ì›, ë¶ˆê°€í•˜ë©´ ì¬ì‹œì‘ ì •ì±… ë¬¸ì„œí™”

3.3 ì´ë²¤íŠ¸ íƒ€ì… ê³„ì•½ (Aura UI v1.0)
- í‘œì¤€ ì´ë²¤íŠ¸: thought, plan_step, tool_execution, hitl, content, timeline_step_update, plan_step_update
- ì¢…ë£Œ ì„ ì–¸: data: [DONE]\n\n

4. HITL (Human-In-The-Loop) & ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤
- State ì†Œìœ ê¶Œ: dwp-main-serviceê°€ ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœë¥¼ ë‹¨ì¼ ì†Œìœ 
- ìŠ¹ì¸ ì „íŒŒ: Redis Pub/Subìœ¼ë¡œ Aura-Platformì— ì‹ í˜¸ ë°œí–‰
- ë³´ì•ˆ: ìš”ì²­ì ê¶Œí•œ + í…Œë„ŒíŠ¸ ì¼ì¹˜ ì¬ê²€ì¦

5. AgentTask ë° ë¹„ë™ê¸° ì‘ì—… ê´€ë¦¬
- ì˜ì†í™”: ëª¨ë“  ì—ì´ì „íŠ¸ ìš”ì²­ì€ AgentTaskë¡œ DB ê¸°ë¡
- ì§„í–‰ë„: planSteps(JSON), progress(0~100), ìƒíƒœ(REQUESTED/IN_PROGRESS/COMPLETED/FAILED)
- ë¹„ë™ê¸° ì²˜ë¦¬: 10ì´ˆ ì´ìƒ ì‘ì—…ì€ ë¹„ë™ê¸° ì²˜ë¦¬ + taskId ì¦‰ì‹œ ë°˜í™˜

6. ë°ì´í„° ë° ê¸°ìˆ  í‘œì¤€
- Stack: Java 17, Spring Boot 3.4.x, Spring Cloud Gateway, OpenFeign, Redis 7, PostgreSQL 15
- Response: ëª¨ë“  API ì‘ë‹µì€ dwp-coreì˜ ApiResponse<T>ë¡œ í†µì¼
- JWT: Python â†” Java HS256 í˜¸í™˜ì„± ìœ ì§€ (í´ë ˆì„/ê²€ì¦ ê·œì¹™ ë¬¸ì„œë¡œ ê³ ì •)

7. ì½”ë“œ í’ˆì§ˆ ë° ì¶”ì ì„± (Traceability)
- Swagger(springdoc-openapi)ë¡œ API ëª…ì„¸ ìë™ ìƒì„±
- Logging:
  - traceId + X-Agent-ID í¬í•¨ ê¶Œì¥
  - Gateway/Downstream Correlation ì „ëµ ìœ ì§€
- Header Injection:
  - FeignClient RequestInterceptorë¡œ í‘œì¤€ í—¤ë” ìë™ ì£¼ì…/ì „íŒŒ

8. ë³´ì•ˆ ë° ë©€í‹°í…Œë„Œì‹œ
- Data Isolation: ëª¨ë“  DB ì¡°íšŒëŠ” tenant_id í•„í„° ê°•ì œ
- RBAC Scope: ê¶Œí•œ ë°– ì ‘ê·¼(íƒ€ í…Œë„ŒíŠ¸ í¬í•¨) ì°¨ë‹¨

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§© Admin CRUD Engineering Pattern (Hard Standard)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Admin CRUD APIëŠ” â€œìš´ì˜ ìœ ì§€ë³´ìˆ˜â€ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ í‘œì¤€ ë¶„ë¦¬ êµ¬ì¡°ë¥¼ ë”°ë¥¸ë‹¤.
- ControllerëŠ” mapping + guardë§Œ
- Query/Command ë¶„ë¦¬ë¡œ ì„œë¹„ìŠ¤ ë¹„ëŒ€í™” ë°©ì§€
- í•˜ë“œì½”ë”© ì œê±°(CodeResolver/CodeUsage ê¸°ë°˜)

[íŒ¨í‚¤ì§€ í‘œì¤€]
controller/admin/
service/admin/<feature>/
  - <Feature>QueryService
  - <Feature>CommandService
  - <Feature>Validator
dto/admin/<feature>/
repository/
entity/

[API í†µì¼]
GET    /api/admin/<feature>              # list
GET    /api/admin/<feature>/{id}         # detail
POST   /api/admin/<feature>              # create
PATCH  /api/admin/<feature>/{id}         # update
DELETE /api/admin/<feature>/{id}         # delete

[ê¶Œí•œ]
- /api/admin/** : JWT í•„ìˆ˜ + ADMIN enforcement
- sidebar ìˆ¨ê¹€ê³¼ ë¬´ê´€í•˜ê²Œ BE enforcementê°€ ìµœì¢… ë³´ì•ˆ ê¸°ì¤€

[ì½”ë“œ í•˜ë“œì½”ë”© ê¸ˆì§€]
- "MENU","UI_COMPONENT","USER","ADMIN"... ì§ì ‘ ë¹„êµ ê¸ˆì§€
- CodeResolver.require/validate + CodeUsage ë²”ìœ„ ë‚´ ì½”ë“œë§Œ í—ˆìš©

[ê°ì‚¬ë¡œê·¸]
- ëª¨ë“  CRUDëŠ” com_audit_logs ê¸°ë¡ ê¸°ë³¸ê°’
- before/after json ê°€ëŠ¥í•œ ë²”ìœ„ ê¸°ë¡ ê¶Œì¥

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§¹ Maintainability & Refactor Gate (ìš´ì˜ ìœ ì§€ë³´ìˆ˜ ê·œì¹™)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Class Size Limit (Hard)
  - Controller: 250ë¼ì¸ ì´ˆê³¼ ê¸ˆì§€
  - Service: 350ë¼ì¸ ì´ˆê³¼ ê¸ˆì§€
  - Repository/Entity: 300ë¼ì¸ ì´ˆê³¼ ê¸ˆì§€
  - ì´ˆê³¼ ì‹œ ë°˜ë“œì‹œ ì±…ì„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•œë‹¤.

- Layered Responsibility (Mandatory)
  - Controller: Request/Response ë§¤í•‘ + ì¸ì¦/ê¶Œí•œ Guard í˜¸ì¶œë§Œ ë‹´ë‹¹
  - Service: ìœ ì¦ˆì¼€ì´ìŠ¤ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ë§Œ ë‹´ë‹¹
  - ì„¸ë¶€ ë¡œì§ì€ ì•„ë˜ë¡œ ë¶„ë¦¬:
    - *QueryService: ì¡°íšŒ ì „ìš©(ê²€ìƒ‰/í˜ì´ì§•/ì •ë ¬)
    - *CommandService: ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì „ìš©
    - *Validator: ì…ë ¥ê°’/ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ê²€ì¦
    - *Mapper: Entity â†” DTO ë³€í™˜ ì „ìš©

- Transaction Rule
  - ì¡°íšŒ: @Transactional(readOnly = true)
  - ìƒì„±/ìˆ˜ì •/ì‚­ì œ: @Transactional ëª…ì‹œ
  - Controllerì—ì„œ @Transactional ê¸ˆì§€

- Contract Safety
  - API ì‘ë‹µ DTO ë³€ê²½ì€ ë°˜ë“œì‹œ ë²„ì „/í˜¸í™˜ì„± ê³ ë ¤
  - í”„ë¡ íŠ¸ ê³„ì•½ ì˜í–¥ì´ ìˆìœ¼ë©´ docs/ì— API Spec ì—…ë°ì´íŠ¸ í•„ìˆ˜

- Testing Gate (Minimum)
  - Query/Command ê°ê° í•µì‹¬ í…ŒìŠ¤íŠ¸ 1ê°œ ì´ìƒ í•„ìˆ˜
  - Role/Permission ê³„ì‚°, CodeUsage ë§¤í•‘ ë¡œì§ì€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ìœ ì§€

- Refactor Rule
  - ë¦¬íŒ©í† ë§ PRì—ì„œëŠ” ê¸°ëŠ¥ ë³€ê²½ ê¸ˆì§€(ë™ì‘/ì‘ë‹µ ë™ì¼ ìœ ì§€)
  - ì˜ˆì™¸: ëª…ë°±í•œ ë²„ê·¸/ì„±ëŠ¥ ë¬¸ì œ í•´ê²°ì€ í—ˆìš©

[Cursor Action Guideline]
ë³¸ ê·œì¹™ì„ ë°”íƒ•ìœ¼ë¡œ ì½”ë“œë¥¼ ìƒì„±í•  ë•Œ, íŠ¹íˆ Gateway ì„¤ì • / Header ì „íŒŒ / SSE ìŠ¤íŠ¸ë¦¬ë° ë°˜í™˜ë¶€ì—ì„œ
ê·œê²© ìœ„ë°˜ì´ ì—†ëŠ”ì§€ ìµœìš°ì„ ìœ¼ë¡œ ê²€ì¦í•˜ì‹­ì‹œì˜¤.
