# DWP Backend Integrated Development Rules (v1.2)

## 1. 아키텍처 원칙 & 모듈별 역할 (Architecture & Modules)
- **Multi-Module MSA**: Spring Boot 3.x 기반 Gradle 멀티 모듈 구조를 엄격히 준수한다.
- **Module Responsibility**:
  - `dwp-core`: 모든 모듈의 공통 기반. DTO, 예외 처리, Redis 설정, 공통 상수 관리.
  - `dwp-gateway`: 모든 외부 진입점. SSE 스트리밍 중계 및 라우팅 전담.
  - `dwp-main-service`: AI 에이전트의 작업 상태(`AgentTask`) 및 HITL(승인) 로직 전담 관리.
  - `services/*`: 개별 비즈니스 도메인. AI가 호출할 '도구'로서의 API 제공.

## 2. AI 에이전트 & SSE 통신 규격 (Agentic AI & SSE)
- **Aura AI UI v1.0 규격 준수**: AI 응답 데이터 모델은 프론트엔드 명세의 `thought`, `plan_step`, `tool_execution`, `hitl`, `content` 타입을 지원해야 한다.
- **SSE Support**: `dwp-gateway`와 각 서비스는 `MediaType.TEXT_EVENT_STREAM_VALUE`를 통한 실시간 스트리밍을 지원하며, 게이트웨이 타임아웃은 최소 300초로 설정한다.
- **HITL (Human-in-the-loop)**: 승인이 필요한 작업은 `dwp-main-service`를 통해 `waiting_for_approval` 상태를 관리하고, Redis Pub/Sub을 통해 에이전트에 신호를 전달한다.
- **AgentTask Management**: 모든 에이전트 작업은 `AgentTask` 엔티티로 영속화하며, 실행 계획(`plan_steps`)을 JSON 형태로 포함해야 한다.

## 3. 기술 스택 & 데이터 표준 (Standard Tech Stack)
- **Core**: Java 17, Spring Boot 3.4.x
- **Communication**: OpenFeign (헤더 전파 필수: `X-Tenant-ID`, `X-DWP-Source`)
- **Security**: JWT (HS256) 기반 공유 시크릿 검증. 멀티테넌시(`tenant_id`) 클레임 필수 확인.
- **Persistence**: PostgreSQL 15+, JPA (Soft Delete 권장)
- **Messaging**: Redis 7 (Pub/Sub을 통한 AI 상태 동기화 및 캐싱)

## 4. 코드 작성 및 응답 표준 (Coding Standards)
- **Unified Response**: 모든 응답은 `dwp-core`의 `ApiResponse<T>` 객체로 래핑한다.
- **LLM-Friendly API**: `@Operation`을 사용하여 파라미터와 기능의 상세 설명을 작성한다. (AI 도구 인식용)
- **Traceability**: 에이전트 호출 시 `X-DWP-Caller-Type: AGENT` 헤더를 전파하고 로깅한다.
- **Long-running Task**: 10초 이상의 작업은 비동기로 처리하고 `task_id`를 반환하는 패턴을 사용한다.

## 5. 멀티테넌시 및 보안 (Multi-tenancy)
- **Tenant Isolation**: 모든 요청에서 `X-Tenant-ID`를 식별하고 DB 조회 시 테넌트 필터링을 강제한다.
- **RBAC**: 에이전트 전용 권한 스코프를 정의하여 관리한다.

## 6. 품질 및 문서화 (Quality & Docs)
- **Swagger**: 모든 API는 최신 Swagger UI를 통해 문서를 자동화한다.
- **Async Logic**: 대량 처리나 외부 연동은 `@Async` 또는 `CompletableFuture`를 활용한다.